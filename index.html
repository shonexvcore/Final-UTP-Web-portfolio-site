<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNDER THE PARK | Creative Studio</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,600;1,400&family=Manrope:wght@300;400;600&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Flip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollToPlugin.min.js"></script>
    <script src="https://unpkg.com/lenis@1.0.45/dist/lenis.min.js"></script>

    <!-- 3D & AI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <style>
        :root {
            --bg: #050505;
            --text: #e0e0e0;
            --accent: #64ffb4;
            --font-title: 'Syncopate', sans-serif;
            --font-serif: 'Cormorant Garamond', serif;
            --font-body: 'Manrope', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }
        html, body { width: 100%; max-width: 100%; overflow-x: hidden; }
        @media (pointer: coarse) { * { cursor: auto !important; } }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-body);
            height: 100vh;
            overflow: hidden;
        }
        body.ready { height: auto; overflow-y: auto; }

        /* Transition Curtain */
        #page-transition {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999; pointer-events: none; opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* 3D Background */
        #canvas-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0; transition: opacity 2s ease;
        }
        body.ready #canvas-background { opacity: 0.8; }

        /* Camera Feed */
        #input_video {
            position: absolute; bottom: 0; left: 0; width: 1px; height: 1px;
            opacity: 0; pointer-events: none; z-index: -10; visibility: hidden;
        }

        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .brain-loader-container { position: relative; width: 200px; height: 200px; transform-style: preserve-3d; perspective: 1000px; margin-bottom: 2rem; }
        .brain-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 1px solid rgba(100, 255, 180, 0.8); border-radius: 50%; box-shadow: 0 0 15px rgba(100, 255, 180, 0.3); opacity: 0.9; }
        .brain-ring:nth-child(1) { width: 100px; height: 140px; animation: brainSpin 4s linear infinite; border-style: solid; }
        .brain-ring:nth-child(2) { width: 110px; height: 130px; animation: brainSpin 6s linear infinite reverse; transform: translate(-50%, -50%) rotateY(45deg); }
        .brain-ring:nth-child(3) { width: 90px; height: 150px; animation: brainSpin 5s linear infinite; transform: translate(-50%, -50%) rotateY(90deg); border-color: rgba(255,255,255,0.5); }
        .brain-ring:nth-child(4) { width: 120px; height: 110px; animation: brainSpin 7s linear infinite reverse; transform: translate(-50%, -50%) rotateX(60deg); }
        @keyframes brainSpin { 0% { transform: translate(-50%, -50%) rotate3d(1, 1, 1, 0deg); } 100% { transform: translate(-50%, -50%) rotate3d(1, 1, 1, 360deg); } }
        .loader-count { font-family: var(--font-title); font-size: 3rem; color: #fff; line-height: 1; margin-top: 20px; }

        /* UI Elements */
        .mode-switch-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }
        .mode-label { font-family: var(--font-title); font-size: 0.7rem; letter-spacing: 0.1em; color: #666; transition: color 0.3s; }
        .mode-switch { width: 50px; height: 26px; border: 1px solid rgba(255,255,255,0.3); border-radius: 13px; position: relative; cursor: pointer; transition: border-color 0.3s; }
        .mode-knob { width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1), background-color 0.3s; }
        .mode-switch.active { border-color: var(--accent); }
        .mode-switch.active .mode-knob { transform: translateX(24px); background-color: var(--accent); }
        .mode-switch.active + .mode-label { color: var(--accent); }
        .toast-msg { position: fixed; bottom: 5rem; right: 2rem; background: rgba(10, 10, 10, 0.8); border-left: 2px solid var(--accent); padding: 1rem 1.5rem; font-family: var(--font-title); font-size: 0.7rem; letter-spacing: 0.05em; color: #fff; backdrop-filter: blur(5px); transform: translateX(120%); transition: transform 0.5s ease; z-index: 999; max-width: 250px; line-height: 1.5; }
        .toast-msg.show { transform: translateX(0); }

        /* Cursor */
        #cursor { 
            position: fixed; top: 0; left: 0; width: 20px; height: 20px; 
            border: 1px solid rgba(255,255,255,0.8); border-radius: 50%; 
            pointer-events: none; z-index: 99999; transform: translate(-50%, -50%); 
            mix-blend-mode: difference; transition: width 0.3s, height 0.3s, background-color 0.3s; 
        }
        #cursor.hovered { width: 50px; height: 50px; background-color: rgba(255,255,255,0.1); border-color: transparent; backdrop-filter: blur(2px); }

        /* Header */
        .site-header { position: fixed; top: 0; left: 0; width: 100%; padding: 2.5rem 4rem; z-index: 100; display: flex; align-items: center; justify-content: space-between; pointer-events: none; mix-blend-mode: exclusion; }
        .header-left { pointer-events: auto; }
        .company-name { font-family: var(--font-title); font-weight: 700; font-size: 1.2rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; }
        .nav-trigger { pointer-events: auto; cursor: pointer; font-family: var(--font-title); font-size: 0.8rem; letter-spacing: 0.2em; display: flex; gap: 2rem; }
        .nav-item { transition: color 0.3s; }
        .nav-item:hover { color: var(--accent); }

        /* Layout */
        .wrapper { padding: 0 4rem; max-width: 1600px; margin: 0 auto; position: relative; z-index: 10; }
        .section-title { font-family: var(--font-title); font-size: 1.5rem; margin-bottom: 4rem; text-align: center; color: var(--accent); }

        /* Hero */
        .hero { height: 100vh; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .hero-title-container { display: flex; flex-direction: column; width: 100%; }
        .hero-line {
            font-family: var(--font-title); font-size: 11vw; line-height: 0.85;
            text-transform: uppercase; mix-blend-mode: exclusion;
            opacity: 0; transform: translateY(50px);
        }
        .hl-1 { align-self: flex-start; margin-left: -0.5rem; font-weight: 400; }
        .hl-2 { align-self: center; color: var(--accent); font-weight: 700; z-index: 2; }
        .hl-3 { align-self: flex-end; font-weight: 400; -webkit-text-stroke: 1px #fff; color: transparent; }
        .hero-sub { margin-top: 4rem; font-size: 1rem; letter-spacing: 0.1em; color: #888; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; padding-top: 1rem; font-family: var(--font-body); opacity: 0; }

        /* Intro */
        .about-intro { padding-top: 15vh; padding-bottom: 15vh; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .intro-origin { margin-bottom: 4rem; }
        .origin-label { font-family: var(--font-title); font-size: 0.8rem; letter-spacing: 0.2em; color: var(--accent); display: block; margin-bottom: 1rem; }
        .origin-title { font-family: var(--font-title); font-size: 3vw; line-height: 1.2; text-transform: uppercase; font-weight: 700; }
        .intro-body { max-width: 800px; margin: 0 auto; }
        .intro-text-pc { display: block; }
        .intro-text-sp { display: none; }
        .intro-jp { font-size: 1.2rem; line-height: 2.2; margin-bottom: 6rem; font-feature-settings: "palt"; letter-spacing: 0.05em; }
        .intro-en { font-family: var(--font-body); font-size: 1.1rem; line-height: 1.8; color: #aaa; font-weight: 300; }

        /* Works */
        .works-section { padding-top: 10vh; padding-bottom: 20vh; }
        .work-list { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5vw; }
        .work-item { position: relative; display: flex; flex-direction: column; cursor: pointer; transition: transform 0.5s ease; }
        .work-item:nth-child(even) { margin-top: 4vh; }
        .img-reveal { width: 100%; aspect-ratio: 16/10; overflow: hidden; position: relative; background: #0a0a0a; border-radius: 2px; }
        .img-reveal img { width: 100%; height: 120%; object-fit: cover; object-position: center; filter: brightness(1.0); transition: transform 0.8s cubic-bezier(0.19, 1, 0.22, 1), filter 0.5s ease; will-change: transform; }
        .work-item:hover .img-reveal img { transform: scale(1.1); filter: brightness(1.2); }
        .work-item:hover { z-index: 10; }
        .type-badge { position: absolute; top: 1rem; left: 1rem; background: rgba(0,0,0,0.7); color: #fff; border: 1px solid rgba(255,255,255,0.3); font-family: var(--font-title); font-size: 0.5rem; padding: 0.3rem 0.5rem; z-index: 2; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s; }
        .work-item:hover .type-badge { opacity: 1; }
        .work-year { position: absolute; top: 1rem; right: 1rem; background: #fff; color: #000; font-family: var(--font-title); font-size: 0.7rem; padding: 0.3rem 0.8rem; opacity: 0; transition: opacity 0.4s; z-index: 2; transform: translateY(10px); }
        .work-item:hover .work-year { opacity: 1; transform: translateY(0); }
        .work-info { margin-top: 1rem; display: flex; justify-content: space-between; align-items: flex-start; opacity: 0.7; transition: opacity 0.3s; }
        .work-item:hover .work-info { opacity: 1; }
        .work-title { font-family: var(--font-title); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .work-cat { font-size: 0.7rem; color: #aaa; font-style: italic; }

        /* Workflow */
        .workflow-section { padding-top: 10vh; padding-bottom: 20vh; position: relative; z-index: 10; }
        .workflow-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem; margin-bottom: 2rem; }
        .workflow-grid-bottom { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; max-width: 75%; margin: 0 auto; }
        .workflow-item { padding: 2rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; transition: all 0.3s; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .workflow-item:hover { border-color: var(--accent); transform: translateY(-5px); }
        .wf-num { font-family: var(--font-title); color: var(--accent); font-size: 0.8rem; margin-bottom: 1rem; display: block; }
        .wf-title-jp { font-size: 1.1rem; margin-bottom: 0.8rem; font-weight: 600; color: #fff; }
        .wf-desc-en { font-family: var(--font-body); font-size: 0.9rem; color: #aaa; line-height: 1.6; }

        /* Footer */
        footer { height: 60vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10; background: transparent; }
        .footer-link { font-family: var(--font-title); font-size: 2.5rem; font-weight: 700; text-transform: uppercase; color: #fff; letter-spacing: 0.3em; cursor: pointer; position: relative; padding: 1rem 2rem; border: 1px solid rgba(255,255,255,0.1); transition: all 0.5s ease; overflow: hidden; text-decoration: none; }
        .footer-link::before { content: ''; position: absolute; top: 0; left: 0; width: 0%; height: 100%; background: #fff; transition: width 0.5s cubic-bezier(0.19, 1, 0.22, 1); z-index: -1; }
        .footer-link:hover { color: #000; border-color: #fff; }
        .footer-link:hover::before { width: 100%; }

        /* SPA Overlays */
        .page-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: rgba(4, 4, 4, 0.99); z-index: 5000; opacity: 0; pointer-events: none; 
            transition: opacity 0.5s ease; backdrop-filter: blur(20px); visibility: hidden; 
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .page-overlay.active { opacity: 1; pointer-events: auto; visibility: visible; }
        
        .overlay-close-fixed { 
            position: fixed; top: 2.5rem; right: 4rem; font-family: var(--font-title); font-size: 0.8rem; 
            letter-spacing: 0.2em; cursor: pointer; border: 1px solid rgba(255,255,255,0.3); 
            padding: 0.8rem 2rem; transition: all 0.3s; z-index: 6000; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); opacity: 0; pointer-events: none; 
        }
        .page-overlay.active ~ .overlay-close-fixed, .page-overlay.active .overlay-close-fixed { opacity: 1; pointer-events: auto; }
        .overlay-close-fixed:hover { background: #fff; color: #000; }

        .overlay-content { text-align: center; max-width: 900px; margin: 0 auto; padding: 120px 1.5rem 100px 1.5rem; }
        .overlay-title { font-family: var(--font-title); font-size: 3rem; margin-bottom: 3rem; color: var(--accent); }

        /* SPA Detail Layout */
        .detail-wrapper { display: flow-root; width: 100%; }
        #project-detail-overlay .detail-hero-media { width: 100%; height: 85vh; height: 85dvh; background: #000; overflow: hidden; }
        #project-detail-overlay .detail-hero-media img, #project-detail-overlay .detail-hero-media video { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        #project-detail-overlay .detail-content-area { text-align: left; max-width: 900px; margin: 0 auto; padding: 10vh 2rem 5vh 2rem; }
        #project-detail-overlay .detail-meta { font-family: var(--font-title); color: var(--accent); display: block; margin-bottom: 1rem; font-size: 0.7rem; letter-spacing: 0.2em; }
        #project-detail-overlay .detail-title { font-family: var(--font-title); line-height: 1.1; color: #fff; margin-bottom: 2rem; font-size: clamp(1.8rem, 7vw, 3.5rem); text-transform: uppercase; }
        #project-detail-overlay .detail-desc { font-size: 1.1rem; line-height: 1.8; color: #aaa; margin-bottom: 6rem; font-weight: 300; }
        #project-detail-overlay .detail-gallery { display: flex; flex-direction: column; gap: 4rem; padding-bottom: 6rem; }
        #project-detail-overlay .detail-gallery-item img { width: 100%; height: auto; display: block; }
        #project-detail-overlay .detail-nav { display: flex; justify-content: space-between; align-items: center; padding: 4rem 0; border-top: 1px solid #222; }
        #project-detail-overlay .detail-nav-btn { cursor: pointer; font-family: var(--font-title); font-size: 0.8rem; color: #666; transition: color 0.3s; letter-spacing: 0.2em; }
        #project-detail-overlay .detail-nav-btn:hover { color: var(--accent); }
        .detail-archive-footer { padding: 10vh 0 15vh 0; border-top: 1px solid #222; text-align: center; }
        .detail-archive-footer span { font-size: 0.7rem; color: #555; display: block; margin-bottom: 1rem; letter-spacing: 0.3em; font-family: var(--font-title); }
        .detail-archive-footer h2 { font-family: var(--font-title); font-size: clamp(1.5rem, 5vw, 2.5rem); color: #fff; cursor: pointer; transition: color 0.3s; }
        .detail-archive-footer h2:hover { color: var(--accent); }

        @media (max-width: 1024px) {
            .workflow-grid-bottom { max-width: 100%; }
        }
        @media (max-width: 768px) {
            .site-header { padding: 1.5rem 1rem; flex-direction: column; gap: 1rem; } 
            .nav-trigger { width: 100%; justify-content: center; gap: 1.2rem; font-size: 0.7rem; }
            .wrapper { padding: 0 1.5rem; }
            .hero-line { font-size: 13vw; } .origin-title { font-size: 8vw; }
            .intro-text-pc { display: none; } .intro-text-sp { display: block; }
            .works-section { padding-top: 10vh; }
            .work-list { grid-template-columns: 1fr; } .work-item:nth-child(even) { margin-top: 0; }
            .workflow-grid, .workflow-grid-bottom { grid-template-columns: 1fr; gap: 1rem; }
            .footer-link { font-size: 1.1rem; padding: 0.8rem 1.5rem; white-space: nowrap; }
            .overlay-close-fixed { top: 1rem; right: 1rem; padding: 0.7rem 1.2rem; font-size: 0.6rem; }
            .mode-switch-container { display: none; }
            #project-detail-overlay .detail-hero-media { height: 60vh; }
            @media (orientation: landscape) {
                .site-header { flex-direction: row; padding: 1rem 1.5rem; }
                .hero-line { font-size: 15vh; } .origin-title { font-size: 12vh; }
            }
        }
    </style>
</head>
<body>

    <script>
        if (sessionStorage.getItem('visited')) {
            document.write('<style>#loader { display: none !important; }</style>');
        }
    </script>

    <video id="input_video" autoplay playsinline muted></video>
    <div id="canvas-background"></div>

    <div class="mode-switch-container">
        <div class="mode-switch hover-target" id="cam-switch">
            <div class="mode-knob"></div>
        </div>
        <div class="mode-label">3D INTERACTION</div>
    </div>
    
    <div class="toast-msg" id="toast-msg">
        FACE TRACKING ENABLED<br><span style="font-size: 0.6em; opacity: 0.7;">MOVE CLOSER TO ZOOM IN</span>
    </div>
    
    <div id="page-transition"></div>

    <header class="site-header">
        <div class="header-left"><div class="company-name hover-target" onclick="closeProjectDetail()">UNDER THE PARK</div></div>
        <nav class="nav-trigger">
            <div class="nav-item hover-target" onclick="goToPage('about.html')">ABOUT</div>
            <div class="nav-item hover-target" onclick="scrollToWorkflow()">PROCESS</div>
            <div class="nav-item hover-target" onclick="openOverlay('contact')">CONTACT</div>
        </nav>
    </header>

    <div id="loader">
        <div class="brain-loader-container">
            <div class="brain-ring"></div><div class="brain-ring"></div><div class="brain-ring"></div><div class="brain-ring"></div>
        </div>
        <div class="loader-count">00</div>
    </div>

    <div id="cursor"></div>

    <main id="main">
        <section class="hero wrapper">
            <div class="hero-title-container">
                <div class="hero-line hl-1">WHERE</div>
                <div class="hero-line hl-2">VISION</div>
                <div class="hero-line hl-3">BREATHES</div>
            </div>
            <div class="hero-sub">
                <span>SCROLL TO EXPLORE</span>
                <span>TOKYO, JP &mdash; 2025</span>
            </div>
        </section>

        <section class="about-intro wrapper">
            <div class="intro-origin">
                <span class="origin-label">OUR ORIGIN</span>
                <h2 class="origin-title">THE "PARK" STANDS FOR<br>PERFECT QUALITY</h2>
            </div>
            <div class="intro-body">
                <p class="intro-text-pc intro-jp">
                    UNDER THE PARKの『PARK』は、PERFECT QUALITYに由来します。<br>
                    東京を拠点に、映像、写真、デザインを横断するクリエイティブ・コレクティブ。<br>
                    洗練された美学と鋭敏な感性で、見えざる本質を捉え、<br>
                    普遍的な価値を持つ『最高品質』のビジュアルへと昇華させます。
                </p>
                <p class="intro-text-sp intro-jp">
                    洗練された美学と鋭敏な感性で、<br>
                    見えざる本質を捉え<br>
                    普遍的な価値を持つ最高品質の<br>
                    ビジュアルへと昇華させます。
                </p>
            </div>
        </section>

        <section class="works-section wrapper">
            <div class="work-list" id="work-list"></div>
        </section>

        <section class="workflow-section wrapper" id="workflow">
            <div class="section-title">WORKFLOW</div>
            <div class="workflow-grid">
                <div class="workflow-item"><span class="wf-num">01. INQUIRY</span><h3 class="wf-title-jp">お問い合わせ</h3><p class="wf-desc-en">Please contact us via email with project details.</p></div>
                <div class="workflow-item"><span class="wf-num">02. HEARING</span><h3 class="wf-title-jp">ヒアリング</h3><p class="wf-desc-en">We review your request and provide an estimate.</p></div>
                <div class="workflow-item"><span class="wf-num">03. PLANNING</span><h3 class="wf-title-jp">企画構成</h3><p class="wf-desc-en">We finalize creative direction and logistics.</p></div>
                <div class="workflow-item"><span class="wf-num">04. AGREEMENT</span><h3 class="wf-title-jp">アサイン</h3><p class="wf-desc-en">Based on the plan, we assign the best creators.</p></div>
            </div>
            <div class="workflow-grid-bottom">
                <div class="workflow-item"><span class="wf-num">05. PRODUCTION</span><h3 class="wf-title-jp">撮影・編集</h3><p class="wf-desc-en">Execution of shooting and high-end post-production.</p></div>
                <div class="workflow-item"><span class="wf-num">06. REVIEW</span><h3 class="wf-title-jp">納品・調整</h3><p class="wf-desc-en">Submission of deliverables and final adjustments.</p></div>
                <div class="workflow-item"><span class="wf-num">07. COMPLETION</span><h3 class="wf-title-jp">プロジェクト完了</h3><p class="wf-desc-en">Project completion. We look forward to future collaborations.</p></div>
            </div>
        </section>

        <footer class="wrapper">
            <div class="footer-link hover-target" onclick="openOverlay('contact')">START A PROJECT</div>
        </footer>
    </main>

    <div id="contact-overlay" class="page-overlay">
        <div class="overlay-close-fixed hover-target" onclick="closeOverlay('contact')">CLOSE</div>
        <div class="overlay-content">
            <h2 class="overlay-title">CONTACT</h2>
            <p style="color: #aaa; font-size: 1.1rem; line-height: 2;">
                For project inquiries and collaborations:<br>
                <span style="color:#fff; font-size:1.5rem;">hello@underthepark.jp</span>
            </p>
        </div>
    </div>

    <div id="project-detail-overlay" class="page-overlay" data-lenis-prevent>
        <div class="overlay-close-fixed hover-target" onclick="closeProjectDetail()">CLOSE</div>
        <div id="detail-content-target"></div>
    </div>

    <script>
        if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
        window.scrollTo(0, 0);

        let currentDetailId = null;
        let isThreePaused = false;
        let savedScrollPos = 0;

        window.openProjectDetail = function(id) {
            const proj = projects.find(p => p.id === parseInt(id));
            if (!proj) return;
            savedScrollPos = window.scrollY;
            if(window.lenis) window.lenis.stop();
            isThreePaused = true;
            currentDetailId = proj.id;
            const target = document.getElementById('detail-content-target');
            const heroMedia = proj.type === 'video' 
                ? `<video src="https://videos.pexels.com/video-files/3195394/3195394-uhd_2560_1440_25fps.mp4" autoplay loop muted playsinline></video>`
                : `<img src="${proj.thumb}?q=80&w=1600" alt="">`;

            target.innerHTML = `
                <div class="detail-wrapper">
                    <div class="detail-hero-media">${heroMedia}</div>
                    <div class="detail-content-area">
                        <span class="detail-meta">${proj.category} / ${proj.year}</span>
                        <h1 class="detail-title">${proj.title}</h1>
                        <p class="detail-desc">We approach every project with a focus on "Perfect Quality." This visual exploration captures the intersection between digital structure and natural fluidity.</p>
                        <div class="detail-gallery">
                            <div class="detail-gallery-item reveal"><img src="${proj.thumb}?q=80&w=1200&sig=1"></div>
                            <div class="detail-gallery-item reveal"><img src="${proj.thumb}?q=80&w=1200&sig=2"></div>
                        </div>
                        <nav class="detail-nav">
                            <div class="detail-nav-btn hover-target" onclick="navigateProject(-1)">PREV</div>
                            <div class="detail-nav-btn hover-target" onclick="navigateProject(1)">NEXT</div>
                        </nav>
                        <div class="detail-archive-footer">
                            <span>BACK TO LIST</span>
                            <h2 class="hover-target" onclick="closeProjectDetail()">ARCHIVE</h2>
                        </div>
                    </div>
                </div>
            `;
            const el = document.getElementById('project-detail-overlay');
            el.scrollTop = 0;
            el.classList.add('active');
            gsap.to(el, { opacity: 1, duration: 0.5, onComplete: () => {
                document.getElementById('main').style.visibility = 'hidden';
                el.scrollTop = 0;
            }});
            setTimeout(() => {
                gsap.utils.toArray(".reveal").forEach(item => {
                    gsap.to(item, { opacity: 1, y: 0, duration: 1, ease: "power3.out", scrollTrigger: { trigger: item, start: "top 90%", scroller: "#project-detail-overlay" } });
                });
                ScrollTrigger.refresh();
            }, 100);
            history.pushState({ projectId: proj.id }, '', `?project=${proj.id}`);
        };

        window.closeProjectDetail = function() {
            const el = document.getElementById('project-detail-overlay');
            document.getElementById('main').style.visibility = 'visible';
            isThreePaused = false;
            gsap.to(el, { opacity: 0, duration: 0.4, onComplete: () => {
                el.classList.remove('active');
                currentDetailId = null;
                if(window.lenis) window.lenis.start();
                window.scrollTo(0, savedScrollPos);
                ScrollTrigger.refresh();
                history.pushState(null, '', window.location.pathname);
            }});
        };

        window.navigateProject = function(dir) {
            const currentIndex = projects.findIndex(p => p.id === currentDetailId);
            let nextIndex = currentIndex + dir;
            if (nextIndex < 0) nextIndex = projects.length - 1;
            if (nextIndex >= projects.length) nextIndex = 0;
            const el = document.getElementById('project-detail-overlay');
            gsap.to("#detail-content-target", { opacity: 0, duration: 0.2, onComplete: () => {
                openProjectDetail(projects[nextIndex].id);
                gsap.to("#detail-content-target", { opacity: 1, duration: 0.3 });
                el.scrollTop = 0;
            }});
        };

        window.addEventListener('popstate', (e) => { if (e.state && e.state.projectId) openProjectDetail(e.state.projectId); else closeProjectDetail(); });

        window.openOverlay = function(id) {
            const el = document.getElementById(id + '-overlay');
            el.classList.add('active');
            gsap.to(el, { opacity: 1, duration: 0.3 });
            if(window.lenis) window.lenis.stop();
        }
        window.closeOverlay = function(id) {
            const el = document.getElementById(id + '-overlay');
            gsap.to(el, { opacity: 0, duration: 0.3, onComplete: () => {
                el.classList.remove('active');
                if(window.lenis) window.lenis.start();
            }});
        }
        window.scrollToWorkflow = function() { if(window.lenis) window.lenis.scrollTo('#workflow'); }
        window.goToPage = function(url) {
            sessionStorage.setItem('indexScrollPos', window.scrollY);
            const curtain = document.getElementById('page-transition');
            curtain.style.opacity = '1';
            setTimeout(() => window.location.href = url, 510);
        }

        const projects = [
            { id: 1, type: 'video', title: 'NEON ROOTS', category: 'BRAND FILM', year: '2025', thumb: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb' },
            { id: 2, type: 'photo', title: 'SILENT CONCRETE', category: 'ARCHITECTURAL', year: '2025', thumb: 'https://images.unsplash.com/photo-1478760329108-5c3ed9d495a0' },
            { id: 3, type: 'video', title: 'LIQUID TIME', category: 'COMMERCIAL', year: '2024', thumb: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe' },
            { id: 4, type: 'photo', title: 'URBAN FOSSILS', category: 'ART DIRECTION', year: '2024', thumb: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b' },
            { id: 5, type: 'video', title: 'PROJECT 05', thumb: 'https://images.unsplash.com/photo-1492691527719-9d1e07e534b4', category: 'MV', year: '2024' },
            { id: 6, type: 'photo', title: 'PROJECT 06', thumb: 'https://images.unsplash.com/photo-1511447333015-45b65e60f6d5', category: 'STILL', year: '2024' },
            { id: 7, type: 'video', title: 'PROJECT 07', thumb: 'https://images.unsplash.com/photo-1542206395-9feb3edaa68d', category: 'CM', year: '2023' },
            { id: 8, type: 'photo', title: 'PROJECT 08', thumb: 'https://images.unsplash.com/photo-1505322022379-7c3353ee6291', category: 'ART', year: '2023' },
            { id: 9, type: 'video', title: 'PROJECT 09', thumb: 'https://images.unsplash.com/photo-1629812456605-4a044aa38fbc', category: 'MV', year: '2023' },
            { id: 10, type: 'photo', title: 'PROJECT 10', thumb: 'https://images.unsplash.com/photo-1499540633125-484965b60031', category: 'STILL', year: '2023' },
            { id: 11, type: 'video', title: 'PROJECT 11', thumb: 'https://images.unsplash.com/photo-1504609773096-104ff2c73ba4', category: 'CM', year: '2022' },
            { id: 12, type: 'video', title: 'PROJECT 12', thumb: 'https://images.unsplash.com/photo-1534528741775-53994a69daeb', category: 'FILM', year: '2022' }
        ];

        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(() => {
                const loader = document.getElementById('loader');
                if (loader && !loader.classList.contains('hidden')) {
                    gsap.to(loader, { yPercent: -100, duration: 1, ease: "power2.inOut" });
                    document.body.classList.add('ready');
                    gsap.set(".hero-line", { opacity: 1, y: 0 }); gsap.set(".hero-sub", { opacity: 1 });
                    ScrollTrigger.refresh();
                }
            }, 3000); 

            gsap.registerPlugin(ScrollTrigger, Flip, ScrollToPlugin);
            window.lenis = new Lenis({ duration: 1.2, easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), smooth: true });
            function raf(time) { window.lenis.raf(time); requestAnimationFrame(raf); }
            requestAnimationFrame(raf);
            initThree();

            const loader = document.getElementById('loader');
            const counter = document.querySelector('.loader-count');
            const countObj = { val: 0 };
            const hasVisited = sessionStorage.getItem('visited');
            const handleInitialDetail = () => { const params = new URLSearchParams(window.location.search); if(params.has('project')) openProjectDetail(params.get('project')); };

            if (!hasVisited) {
                const loadTl = gsap.timeline({ onComplete: () => {
                    loader.classList.add('hidden'); document.body.classList.add('ready'); sessionStorage.setItem('visited', 'true');
                    const savedPos = sessionStorage.getItem('indexScrollPos');
                    if (savedPos) { window.scrollTo(0, parseInt(savedPos)); setTimeout(() => { ScrollTrigger.refresh(); }, 100); sessionStorage.removeItem('indexScrollPos'); }
                    handleInitialDetail();
                }});
                loadTl.to(countObj, { val: 100, duration: 2.0, ease: "expo.inOut", onUpdate: () => { counter.innerText = Math.floor(countObj.val).toString().padStart(2, '0'); } })
                .to(".brain-loader-container", { scale: 2, opacity: 0, duration: 0.8, ease: "power2.in" }, "-=0.5")
                .to(loader, { yPercent: -100, duration: 1.0, ease: "power4.inOut" })
                .to(".hero-line", { opacity: 1, y: 0, duration: 1.5, stagger: 0.2, ease: "power4.out" }, "-=0.5")
                .to(".hero-sub", { opacity: 1, duration: 1 }, "-=1");
            } else {
                loader.style.display = 'none'; document.body.classList.add('ready'); document.getElementById('page-transition').style.opacity = 0;
                gsap.set(".hero-line", { opacity: 1, y: 0 }); gsap.set(".hero-sub", { opacity: 1 });
                const savedPos = sessionStorage.getItem('indexScrollPos');
                if (savedPos) { window.scrollTo(0, parseInt(savedPos)); setTimeout(() => { ScrollTrigger.refresh(); }, 100); sessionStorage.removeItem('indexScrollPos'); }
                handleInitialDetail();
            }

            gsap.from(".about-intro", { opacity: 0, y: 50, duration: 1.5, ease: "power3.out", scrollTrigger: { trigger: ".about-intro", start: "top 80%" } });
            
            // ---【修正：3Dタイミング原本復元】---
            ScrollTrigger.create({ trigger: "body", start: "top top", endTrigger: ".intro-jp", end: "bottom 20%", scrub: 1, onUpdate: (self) => { morphProgress = self.progress; } });
            ScrollTrigger.create({ trigger: ".works-section", start: "bottom bottom", endTrigger: "#workflow", end: "center center", scrub: 1, onUpdate: (self) => { partnerProgress = self.progress; } });

            const workList = document.querySelector('.work-list');
            projects.forEach((proj) => {
                const item = document.createElement('div');
                item.className = 'work-item hover-target';
                item.innerHTML = `<div class="img-reveal"><span class="type-badge">${proj.type}</span><span class="work-year">${proj.year}</span><img src="${proj.thumb}?q=80&w=600" loading="lazy"></div><div class="work-info"><h2 class="work-title">${proj.title}</h2><span class="work-cat">${proj.category}</span></div>`;
                item.addEventListener('click', () => { openProjectDetail(proj.id); });
                workList.appendChild(item);
                gsap.from(item, { y: 100, opacity: 0, duration: 1.5, ease: "power4.out", scrollTrigger: { trigger: item, start: "top 90%" } });
            });
            const cursor = document.getElementById('cursor');
            window.addEventListener('mousemove', (e) => { gsap.to(cursor, {x: e.clientX, y: e.clientY, duration: 0.1}); });
            document.addEventListener('mouseover', (e) => { if(e.target.closest('.hover-target')) cursor.classList.add('hovered'); else cursor.classList.remove('hovered'); });
        });

        // --- 3D Logic ---
        let scene, camera, renderer, points, material, geometry, basePositions, textPositions, partnerPositions; 
        let morphProgress = 0; let partnerProgress = 0; let targetScale = 1.0; let currentScale = 1.0; let time = 0;
        const COLORS = [ new THREE.Color('#64ffb4'), new THREE.Color('#64c4ff'), new THREE.Color('#b464ff'), new THREE.Color('#ffae64') ];
        let currentColorIndex = 0;

        async function initThree() {
            const container = document.getElementById('canvas-background');
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x050505, 0.02);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            // ---【修正：カメラ位置原本復元】---
            camera.position.z = (window.innerWidth < 768) ? 18 : 8;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            createParticles(); startColorCycle(); animate();
        }

        function getCoordinatesFromText(t1, t2, fs, gap=4) {
            const c = document.createElement('canvas'); const w = 2048, h = 1024; c.width = w; c.height = h;
            const ctx = c.getContext('2d'); ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h); ctx.fillStyle = '#fff';
            ctx.font = `900 ${fs}px sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(t1, w/2, h/2 - 120); if(t2) ctx.fillText(t2, w/2, h/2 + 120);
            const d = ctx.getImageData(0,0,w,h).data; const coords = [];
            for(let y=0; y<h; y+=gap) { for(let x=0; x<w; x+=gap) { if(d[(y*w+x)*4] > 128) coords.push({x: (x-w/2)*0.008, y: -(y-h/2)*0.008}); } }
            return coords;
        }

        function createParticles() {
            const count = 20000; const posArr = [], baseArr = [], textArr = [], partnerArr = [], colorArr = [];
            const textCoords = getCoordinatesFromText("WORKS BY", "UNDER THE PARK", 180, 4);
            const partnerCoords = getCoordinatesFromText("PARTNERSHIP", "", 240, 4);
            for (let i = 0; i < count; i++) {
                let bx, by, bz;
                if (Math.random() > 0.4) { const theta = Math.random()*Math.PI*2, r = 3+Math.random()*3; bx = Math.cos(theta)*r; by = (Math.random()-0.5)*0.5; bz = Math.sin(theta)*r; }
                else { const theta = Math.random()*Math.PI*2, phi = Math.acos((Math.random()*2)-1), r = 2.0; bx = r*Math.sin(phi)*Math.cos(theta); by = r*Math.sin(phi)*Math.sin(theta); bz = r*Math.cos(phi); }
                baseArr.push(bx, by, bz); posArr.push(bx, by, bz);
                const tp = textCoords[i % textCoords.length]; textArr.push(tp.x, tp.y, (Math.random()-0.5)*0.2);
                const pp = partnerCoords[i % partnerCoords.length]; partnerArr.push(pp.x, pp.y, (Math.random()-0.5)*0.2);
                colorArr.push(COLORS[0].r, COLORS[0].g, COLORS[0].b);
            }
            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(posArr, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colorArr, 3));
            basePositions = new Float32Array(baseArr); textPositions = new Float32Array(textArr); partnerPositions = new Float32Array(partnerArr);
            const c = document.createElement('canvas'); c.width = 32; c.height = 32;
            const ctx = c.getContext('2d'); const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,1)'); g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
            const tex = new THREE.Texture(c); tex.needsUpdate = true;
            // ---【修正：パーティクルサイズ原本復元】---
            material = new THREE.PointsMaterial({ size: 0.05, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, transparent: true, opacity: 0.8, map: tex });
            points = new THREE.Points(geometry, material); scene.add(points);
        }

        function startColorCycle() {
            const updateColor = () => {
                const next = (currentColorIndex + 1) % COLORS.length;
                const cObj = { r: COLORS[currentColorIndex].r, g: COLORS[currentColorIndex].g, b: COLORS[currentColorIndex].b };
                gsap.to(cObj, { r: COLORS[next].r, g: COLORS[next].g, b: COLORS[next].b, duration: 30, onUpdate: () => {
                    const colors = geometry.attributes.color.array;
                    for (let i = 0; i < colors.length; i += 3) { colors[i] = cObj.r; colors[i+1] = cObj.g; colors[i+2] = cObj.b; }
                    geometry.attributes.color.needsUpdate = true;
                }, onComplete: () => { currentColorIndex = next; updateColor(); } });
            }; updateColor();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (isThreePaused) return;
            time += 0.001;
            if (points) {
                const pos = geometry.attributes.position.array;
                for (let i = 0; i < pos.length; i += 3) {
                    const bx = basePositions[i], by = basePositions[i+1], bz = basePositions[i+2];
                    const tx = textPositions[i], ty = textPositions[i+1], tz = textPositions[i+2];
                    const px = partnerPositions[i], py = partnerPositions[i+1], pz = partnerPositions[i+2];
                    let cx = bx + (tx - bx) * morphProgress, cy = by + (ty - by) * morphProgress, cz = bz + (tz - bz) * morphProgress;
                    if(partnerProgress > 0) { cx += (px - cx) * partnerProgress; cy += (py - cy) * partnerProgress; cz += (pz - cz) * partnerProgress; }
                    pos[i] = cx; pos[i+1] = cy; pos[i+2] = cz;
                }
                geometry.attributes.position.needsUpdate = true;
                currentScale += (targetScale - currentScale) * 0.05; points.scale.set(currentScale, currentScale, currentScale);
                let lock = Math.max(Math.pow(morphProgress, 2), partnerProgress);
                points.rotation.y = (time * 0.2) * (1 - lock);
            }
            renderer.render(scene, camera);
        }

        let lastWidth = window.innerWidth;
        window.addEventListener('resize', () => {
            if (window.innerWidth === lastWidth) return;
            lastWidth = window.innerWidth;
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            camera.position.z = (window.innerWidth < 768) ? 18 : 8;
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function toggleCamera(e) { if (e) { alert("Interaction mode active."); } }
    </script>
</body>
</html>